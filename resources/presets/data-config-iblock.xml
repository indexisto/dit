<dataConfig>

	<!-- TODO: section, user name -->

	<script><![CDATA[
		function getElementUrl(row, context) {
			var url = '';
			try {
	        	var detailPageUrl = row.get('detail_page_url');
	        	if (detailPageUrl == null) return row;
		        
		        var siteDir = 'http://46.4.39.138:8085';
		        var pieces = row.get('detail_page_url').split('/');
				var elementCode = context.getResolvedEntityAttribute('element_code');
				var sectionCode = context.getResolvedEntityAttribute('section_code');	        
				var iblockCode = row.get('iblock_code');

		        for (var i = 0; i < pieces.length; i++) {
		        	var placeholder = pieces[i].match(/#.*#/);
					var substitute = 'tst';
					switch(placeholder + '') {
						case "#SITE_DIR#":
							substitute = siteDir;
							break;
						case '#SECTION_CODE#':
							substitute = sectionCode;
							break;
						case '#CODE#':
							substitute = elementCode;
							break;						
						default:
					}	        	
		        	var piece = (pieces[i] + '').replace(/#.*#/, substitute);
		        	url += piece + '/';
		        }			
			} catch(err) {
				url = 'error: ' + err.message;
			}
	        row.put('url', url);
	        return row;
		}

		function getPictureUrl(row, context) {
			var subdir = row.get('subdir');
			var fileName = row.get('file_name');
			if (fileName == null) return row;
			
			var siteDir = 'http://46.4.39.138:8085/upload/resize_cache';
			var imgSizeDir1 = '298_221_1';
			var imgSizeDir2 = '80_56_1';
			var url = siteDir + '/' + subdir + '/' + imgSizeDir1 + '/' + fileName;
			
			row.put('image_url', url);
			return row;
		}
	]]></script>

	<dataSource type="JdbcDataSource" driver="com.mysql.jdbc.Driver"
		url="jdbc:mysql://localhost/bitrix" user="root" password="s2s" />
	
	<document name="doc">
		<entity name="iblockelement"
			query="SELECT 
			id, iblock_id, iblock_section_id, preview_picture, code as element_code, 
			name, preview_text, detail_text, searchable_content,
			date_create, created_by,
			active_from, active_to 
			FROM b_iblock_element WHERE active='Y'">
			<entity name="section"
				query="SELECT name AS section_name, code AS section_code   
				FROM b_iblock_section 
				WHERE id='${iblockelement.iblock_section_id}' AND active='Y' ">
				<entity name="iblock" 
					element_code="${iblockelement.element_code}"
					section_code="${section.section_code}" 
					transformer="script:getElementUrl"
					query="SELECT name AS iblock_name, code AS iblock_code, detail_page_url  
					FROM b_iblock 
					WHERE id='${iblockelement.iblock_id}' AND active='Y'">
				</entity>
			</entity>
			<entity name="picture" 
				transformer="script:getPictureUrl"
				query="SELECT subdir, file_name   
				FROM b_file 
				WHERE id='${iblockelement.preview_picture}'">
			</entity>			
		</entity>
	</document>
  
</dataConfig>